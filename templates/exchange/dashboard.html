{% extends 'base.html' %} 

{% block content %}
<div style="max-width: 950px; margin: auto; padding-bottom: 50px">
  <h2 style="color: #2d5a27; margin-bottom: 30px">Your Swap Dashboard ðŸ“Š</h2>

  <h3 style="margin-top: 30px; color: #333">Requests for Your Items (Incoming)</h3>
  <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 40px;">
    <tr style="background: #2d5a27; color: white; text-align: left">
      <th style="padding: 15px">Item</th>
      <th style="padding: 15px">From User</th>
      <th style="padding: 15px">Status</th>
      <th style="padding: 15px">Action</th>
    </tr>
    {% for req in incoming %}
    <tr style="border-bottom: 1px solid #eee">
      <td style="padding: 15px"><strong>{{ req.item.title }}</strong></td>
      <td style="padding: 15px">{{ req.sender.username }}</td>
      <td style="padding: 15px">
        <span style="text-transform: capitalize; font-weight: bold; color: {% if req.status == 'accepted' %}#28a745{% elif req.status == 'rejected' %}#dc3545{% elif req.status == 'completed' %}#ffc107{% else %}#6c757d{% endif %}">
          {{ req.status }}
        </span>
      </td>
      <td style="padding: 15px">
        {% if req.status == 'pending' %}
          <a href="{% url 'update_status' req.id 'accepted' %}" style="color: white; background: #28a745; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 14px; margin-right: 5px;">Accept</a>
          <a href="{% url 'update_status' req.id 'rejected' %}" style="color: white; background: #dc3545; padding: 5px 10px; border-radius: 4px; text-decoration: none; font-size: 14px;">Reject</a>
        {% elif req.status == 'accepted' or req.status == 'completed' %}
          <a href="{% url 'chat:chat_room' req.id %}" style="background: #2d5a27; color: white; padding: 7px 14px; border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center;">
            ðŸ’¬ Chat with {{ req.sender.username }}
            <span id="badge-{{ req.id }}"></span> </a>
          {% if req.status == 'completed' %}
            <span style="color: #ffc107; font-weight: 700; margin-left: 8px;">Completed</span>
          {% endif %}
        {% else %}
          <span style="color: #888; font-style: italic">Rejected</span>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="4" style="padding: 30px; text-align: center; color: #888">No incoming requests yet.</td></tr>
    {% endfor %}
  </table>

  <h3 style="margin-top: 50px; color: #333">Requests You Sent (Outgoing)</h3>
  <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
    <tr style="background: #555; color: white; text-align: left">
      <th style="padding: 15px">Item Requested</th>
      <th style="padding: 15px">Owner</th>
      <th style="padding: 15px">Current Status</th>
      <th style="padding: 15px">Contact Info</th>
    </tr>
    {% for req in outgoing %}
    <tr style="border-bottom: 1px solid #eee">
      <td style="padding: 15px"><strong>{{ req.item.title }}</strong></td>
      <td style="padding: 15px">{{ req.item.owner.username }}</td>
      <td style="padding: 15px">
        <span style="text-transform: capitalize; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; 
          {% if req.status == 'accepted' %} background: #d4edda; color: #155724; 
          {% elif req.status == 'rejected' %} background: #f8d7da; color: #721c24; 
          {% else %} background: #fff3cd; color: #856404; {% endif %}">
          {{ req.status }}
        </span>
      </td>
      <td style="padding: 15px">
        {% if req.status == 'accepted' or req.status == 'completed' %}
          <a href="{% url 'chat:chat_room' req.id %}" style="background: #2d5a27; color: white; padding: 7px 14px; border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center;">
            ðŸ’¬ Open Chat
            <span id="badge-{{ req.id }}"></span> </a>
          {% if req.status == 'completed' %}
            <span style="color:#2d5a27; font-weight:700; margin-left:8px;">Completed</span>
          {% endif %}
        {% elif req.status == 'rejected' %}
          <span style="color: #999">Better luck next time!</span>
        {% else %}
          <span style="color: #999">Waiting for response...</span>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="4" style="padding: 30px; text-align: center; color: #888">You haven't requested any items yet.</td></tr>
    {% endfor %}
  </table>
</div>

<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
  const NotificationBadge = ({ swapId }) => {
    const [count, setCount] = React.useState(0);

    React.useEffect(() => {
      const checkNotifications = async () => {
        try {
          const response = await fetch('/chat/api/unread-counts/'); // Ensure this URL matches your urls.py
          const data = await response.json();
          setCount(data[swapId] || 0); // Update count for this specific chat
        } catch (err) {
          console.error("Polling error:", err);
        }
      };

      const interval = setInterval(checkNotifications, 5000); // Poll every 5 seconds
      checkNotifications();
      return () => clearInterval(interval);
    }, [swapId]);

    if (count === 0) return null;

    return (
      <span style={{
        background: '#dc3545',
        color: 'white',
        borderRadius: '50%',
        padding: '2px 8px',
        fontSize: '11px',
        marginLeft: '8px',
        fontWeight: 'bold',
        boxShadow: '0 0 5px rgba(0,0,0,0.2)'
      }}>
        {count}
      </span>
    );
  };

  // Find all badge spans and render the React component
  document.querySelectorAll('[id^="badge-"]').forEach(el => {
    const swapId = el.id.split('-')[1];
    const root = ReactDOM.createRoot(el);
    root.render(<NotificationBadge swapId={swapId} />);
  });
</script>
{% endblock %}